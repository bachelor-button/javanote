(window.webpackJsonp=window.webpackJsonp||[]).push([[96],{2407:function(s,t,a){"use strict";a.r(t);var e=a(21),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"第三节-主主复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第三节-主主复制"}},[s._v("#")]),s._v(" 第三节 主主复制")]),s._v(" "),e("h2",{attrs:{id:"_1、简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1、简介"}},[s._v("#")]),s._v(" 1、简介")]),s._v(" "),e("p",[s._v("对于主从复制来说，其内部会存在一台master以及一台或多台slave。但有一个非常明显的问题，"),e("strong",[s._v("master是单点存在")]),s._v("。一旦master宕机，则无法进行数据的写入。为了解决这个问题，可以使用主主复制架构。")]),s._v(" "),e("p",[s._v("在主主复制架构中，会存在两台master，没有slave。并且会对这两台master进行读写分离，两台master会进行相互的复制, 架构图如下:")]),s._v(" "),e("p",[e("img",{staticClass:"lazy",attrs:{alt:"","data-src":a(625),loading:"lazy"}})]),s._v(" "),e("p",[s._v("在此架构中，两台master会进行双向复制，为什么这么做呢？ 因为假设现在负责写的master宕机了，那么写的工作则会交给之前负责读的服务器来完成，相当于它即负责写又负责读。等到原先负责写的master恢复了，其在继续负责写工作。 反之亦然。因此才需要两者间进行双向复制。")]),s._v(" "),e("p",[e("strong",[s._v("缺点: 读请求的并发量过大，服务可能产生宕机, 主主复制架构直接使用的情况较少。")])]),s._v(" "),e("h2",{attrs:{id:"_2、主主搭建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、主主搭建"}},[s._v("#")]),s._v(" 2、主主搭建")]),s._v(" "),e("p",[s._v("在 docker 中再各自创建一个实例：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("docker run --name mysqlm2 \\\n-p 30000:3306 \\\n--privileged=true \\\n-it \\\n-e MYSQL_ROOT_PASSWORD=123456 \\\n-e MYSQL_USER=user \\\n-e MYSQL_PASSWORD=pass \\\n-v /home/mysql/docker-data/m2/conf:/etc/mysql/conf.d \\\n-v /home/mysql/docker-data/m2/data/:/var/lib/mysql \\\n-v /home/mysql/docker-data/m2/logs/:/var/log/mysql \\\n-d mysql:5.7\n\ndocker run --name mysqlm3 \\\n-p 40000:3306 \\\n--privileged=true \\\n-it \\\n-e MYSQL_ROOT_PASSWORD=123456 \\\n-e MYSQL_USER=user \\\n-e MYSQL_PASSWORD=pass \\\n-v /home/mysql/docker-data/m3/conf:/etc/mysql/conf.d \\\n-v /home/mysql/docker-data/m3/data/:/var/lib/mysql \\\n-v /home/mysql/docker-data/m3/logs/:/var/log/mysql \\\n-d mysql:5.7\n")])])]),e("p",[s._v("/home/mysql/docker-data/m2/conf/my.cnf")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# For advice on how to change settings please see\n# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html\n\n[mysqld]\n#\n# Remove leading # and set to the amount of RAM for the most important data\n# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.\n# innodb_buffer_pool_size = 128M\n#\n# Remove leading # to turn on a very important data integrity option: logging\n# changes to the binary log between backups.\n# log_bin\n#\n# Remove leading # to set options mainly useful for reporting servers.\n# The server defaults are faster for transactions and fast SELECTs.\n# Adjust sizes as needed, experiment to find the optimal values.\n# join_buffer_size = 128M\n# sort_buffer_size = 2M\n# read_rnd_buffer_size = 2M\n\ncharacter_set_server=utf8\ninit_connect='SET NAMES utf8'\n\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n\nlower_case_table_names=1\n#指定主机号，不允许出现重复\nserver-id=1341\n#开启binlog\nlog-bin=mysql-bin\nauto_increment_increment=2\nauto_increment_offset=1\n\n#rpl_semi_sync_master_enabled=1\n#rpl_semi_sync_master_timeout=10000\n")])])]),e("p",[s._v("/home/mysql/docker-data/m3/conf/my.cnf")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# For advice on how to change settings please see")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Remove leading # and set to the amount of RAM for the most important data")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# innodb_buffer_pool_size = 128M")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Remove leading # to turn on a very important data integrity option: logging")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# changes to the binary log between backups.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# log_bin")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Remove leading # to set options mainly useful for reporting servers.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The server defaults are faster for transactions and fast SELECTs.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Adjust sizes as needed, experiment to find the optimal values.")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# join_buffer_size = 128M")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sort_buffer_size = 2M")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# read_rnd_buffer_size = 2M")]),s._v("\n\ncharacter_set_server"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8\ninit_connect"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'SET NAMES utf8'")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Disabling symbolic-links is recommended to prevent assorted security risks")]),s._v("\nsymbolic"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("links"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\nlower_case_table_names"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定主机号，不允许出现重复")]),s._v("\nserver"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("666")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启binlog")]),s._v("\nlog"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("bin\nauto_increment_increment"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nauto_increment_offset"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#rpl_semi_sync_master_enabled=1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#rpl_semi_sync_master_timeout=10000")]),s._v("\n")])])]),e("p",[s._v("❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤")]),s._v(" "),e("p",[s._v("修改 my.cnf 后记得"),e("span",{staticStyle:{color:"blue","font-weight":"bold"}},[s._v("重启")]),s._v(" MySQL 容器！")]),s._v(" "),e("p",[s._v("❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤❤")]),s._v(" "),e("p",[s._v("添加slave的相关配置, 虽然是主主模式,也要添加从用户（供从机访问的用户）")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#添加权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SLAVE"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FILE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" CLIENT "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repluser'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" IDENTIFIED "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#刷新权限")]),s._v("\nFLUSH "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在m2/m3服务器上运行")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#执行主主关联（参考 m2 的状态设置 m3；参考 m3 的状态设置 m2）")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置m2。因为m2要去连m3，所以这里要设置m3的IP地址和端口号。")]),s._v("\nchange master "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" master_host"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.198.120'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repluser'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_password"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_pos"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1104")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置m3。因为m3要去连m2，所以这里要设置m2的IP地址和端口号。")]),s._v("\nchange master "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" master_host"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.198.120'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_user"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repluser'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_password"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("master_log_pos"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1104")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#主主同步生效")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("查看master 129的进程列表：show processlist;")]),s._v(" "),e("p",[e("img",{staticClass:"lazy",attrs:{alt:"image-20210607143921793","data-src":a(626),loading:"lazy"}})]),s._v(" "),e("p",[s._v("slave131的进程列表：show processlist;")]),s._v(" "),e("p",[e("img",{staticClass:"lazy",attrs:{alt:"image-20210607143932355","data-src":a(627),loading:"lazy"}})]),s._v(" "),e("p",[e("RouterLink",{attrs:{to:"/note/advance/mysql/chapter11/verse02.html"}},[s._v("上一节")]),s._v(" "),e("RouterLink",{attrs:{to:"/note/advance/mysql/chapter11/index.html"}},[s._v("回目录")]),s._v(" "),e("RouterLink",{attrs:{to:"/note/advance/mysql/chapter11/verse04.html"}},[s._v("下一节")])],1)])}),[],!1,null,null,null);t.default=n.exports},625:function(s,t,a){s.exports=a.p+"assets/img/image-20200530012403644.db8d324f.png"},626:function(s,t,a){s.exports=a.p+"assets/img/image-20210607143921793.9ddacbc7.png"},627:function(s,t,a){s.exports=a.p+"assets/img/image-20210607143932355.639c1a15.png"}}]);